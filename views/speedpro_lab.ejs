<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€Ÿå‹¢èƒ½é‡ (SpeedPro) å¯¦é©—å®¤</title>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #2d2d2d;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-gold: #fbbf24;
            --accent-green: #10b981;
            --accent-blue: #3b82f6;
            --accent-red: #ef4444;
            --border-color: #404040;
        }

        body { 
            font-family: 'Roboto', 'Segoe UI', Tahoma, sans-serif; 
            padding: 20px; 
            background-color: var(--bg-dark); 
            color: var(--text-main);
            margin: 0;
        }
        
        h1 { color: var(--accent-gold); text-align: center; margin-bottom: 20px; }

        .nav-link {
            background: var(--accent-blue);
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .nav-link:hover { background: #2563eb; }

        .control-panel {
            background: var(--bg-panel);
            padding: 20px;
            border-radius: 8px;
            margin: 0 auto 30px;
            max-width: 800px;
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .lab-panel {
            background: #2e1065; /* Dark Purple for Lab */
            border: 1px solid #8b5cf6;
        }

        .flatpickr-day.has-data {
            background-color: var(--accent-gold) !important;
            color: #000 !important;
            border-color: var(--accent-gold) !important;
            font-weight: bold;
        }

        input[type="text"] {
            background: #404040;
            border: 1px solid #555;
            color: white;
            padding: 10px;
            border-radius: 4px;
            width: 200px;
            text-align: center;
        }

        button {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #2563eb; }

        button.btn-lab {
            background: #8b5cf6;
        }
        button.btn-lab:hover {
            background: #7c3aed;
        }

        button.btn-save {
            background: #10b981;
        }
        button.btn-save:hover {
            background: #059669;
        }

        .stats-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .race-section {
            margin-bottom: 40px;
        }

        .race-title {
            color: var(--accent-gold);
            border-bottom: 2px solid var(--accent-gold);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-panel);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        th, td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: #333;
            color: var(--accent-gold);
            font-weight: bold;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover { background: #444; }
        
        th.sort-asc::after { content: " â–²"; color: #888; font-size: 0.8em; }
        th.sort-desc::after { content: " â–¼"; color: #888; font-size: 0.8em; }

        tr:last-child td { border-bottom: none; }
        tr:hover { background: #383838; }

        .loading { text-align: center; color: var(--text-muted); padding: 20px; display: none; }
        
        .val-pos { color: var(--accent-green); font-weight: bold; }
        .val-neg { color: var(--accent-red); font-weight: bold; }
        .val-neutral { color: var(--text-muted); }

        /* Preview Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--bg-panel);
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--accent-gold);
        }
        .preview-list {
            margin: 20px 0;
            text-align: left;
        }
        .preview-item {
            padding: 10px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
        }

        .top-nav {
            position: absolute; 
            top: 20px; 
            right: 20px; 
            display: flex; 
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }

            .top-nav {
                position: static;
                flex-direction: column;
                margin-bottom: 20px;
            }

            .nav-link {
                text-align: center;
                width: 100%;
                box-sizing: border-box;
            }
            
            h1 { font-size: 1.5em; margin-top: 10px; }

            .control-panel {
                flex-direction: column;
                align-items: stretch;
                padding: 15px;
                gap: 15px;
            }
            
            .control-panel > div {
                 display: flex;
                 flex-direction: column;
                 gap: 5px;
                 width: 100%;
            }
            
            .control-panel select, 
            .control-panel input[type="text"] {
                width: 100%;
                box-sizing: border-box;
            }
            
            button {
                width: 100%;
                margin-bottom: 5px;
            }
            
            /* Ensure tables scroll */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            /* Table scroll hint */
            .stats-container::after {
                content: 'â† å·¦å³æ»‘å‹•æŸ¥çœ‹æ›´å¤š â†’';
                display: block;
                text-align: center;
                color: var(--text-muted);
                font-size: 0.8em;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>

    <div class="top-nav">
        <a href="/" class="nav-link" style="background-color: #666;">ğŸ  è¿”å›é¦–é </a>
        <a href="/speedpro" class="nav-link" style="background-color: #3b82f6;">âš¡ æ¨™æº–åˆ†æ</a>
    </div>

    <h1>âš¡ é€Ÿå‹¢èƒ½é‡ (SpeedPro) å¯¦é©—å®¤ ğŸ§ª</h1>

    <div class="control-panel">
        <div>
            <label>é¸æ“‡è³½äº‹æ—¥æœŸ: </label>
            <input type="text" id="datePicker" placeholder="è«‹é¸æ“‡æ—¥æœŸ...">
        </div>
        <button onclick="fetchData()">æŸ¥è©¢</button>
    </div>

    <div class="control-panel" style="margin-top: 10px; padding: 15px; justify-content: flex-start; flex-wrap: wrap;">
        <span style="font-weight: bold; color: var(--accent-gold); margin-right: 15px;">å¤šé‡æ’åºè¨­å®š:</span>
        
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <label>1st:</label>
            <select id="sort1" onchange="applyMultiSort()" style="padding: 5px; border-radius: 4px; background: #404040; color: white; border: 1px solid #555;">
                <option value="none">-- ç„¡ --</option>
                <option value="statusRating">é¦¬åŒ¹ç‹€æ…‹</option>
                <option value="difference">é€Ÿå‹¢èƒ½é‡ç›¸å·®å€¼</option>
                <option value="assessment">é€Ÿå‹¢èƒ½é‡è©•ä¼°</option>
                <option value="energyReq">æ‰€éœ€èƒ½é‡</option>
                <option value="horseNo" selected>é¦¬è™Ÿ</option>
                <option value="draw">æª”ä½</option>
            </select>
            
            <label>2nd:</label>
            <select id="sort2" onchange="applyMultiSort()" style="padding: 5px; border-radius: 4px; background: #404040; color: white; border: 1px solid #555;">
                <option value="none" selected>-- ç„¡ --</option>
                <option value="statusRating">é¦¬åŒ¹ç‹€æ…‹</option>
                <option value="difference">é€Ÿå‹¢èƒ½é‡ç›¸å·®å€¼</option>
                <option value="assessment">é€Ÿå‹¢èƒ½é‡è©•ä¼°</option>
                <option value="energyReq">æ‰€éœ€èƒ½é‡</option>
                <option value="horseNo">é¦¬è™Ÿ</option>
                <option value="draw">æª”ä½</option>
            </select>

            <label>3rd:</label>
            <select id="sort3" onchange="applyMultiSort()" style="padding: 5px; border-radius: 4px; background: #404040; color: white; border: 1px solid #555;">
                <option value="none" selected>-- ç„¡ --</option>
                <option value="statusRating">é¦¬åŒ¹ç‹€æ…‹</option>
                <option value="difference">é€Ÿå‹¢èƒ½é‡ç›¸å·®å€¼</option>
                <option value="assessment">é€Ÿå‹¢èƒ½é‡è©•ä¼°</option>
                <option value="energyReq">æ‰€éœ€èƒ½é‡</option>
                <option value="horseNo">é¦¬è™Ÿ</option>
                <option value="draw">æª”ä½</option>
            </select>
        </div>
    </div>

    <!-- Lab Control Panel -->
    <div class="control-panel lab-panel">
        <div style="display: flex; gap: 15px; align-items: center; width: 100%; justify-content: center;">
            <label>ğŸ§ª ç­–ç•¥åç¨±:</label>
            <input type="text" id="strategyName" placeholder="ä¾‹å¦‚: ç‹€æ…‹å„ªå…ˆ_v1" style="width: 250px;">
            <button onclick="generatePreview()" class="btn-lab">ä¸€éµç”Ÿæˆé è¦½</button>
        </div>
    </div>

    <div id="loading" class="loading">æ­£åœ¨è¼‰å…¥æ•¸æ“š...</div>

    <div id="results" class="stats-container" style="display: none;">
        <!-- Race tables will be populated here -->
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="color: var(--accent-gold); margin-top: 0;">ç­–ç•¥é è¦½</h2>
            <div id="previewContent" class="preview-list"></div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closePreview()" style="background: #666;">å–æ¶ˆ</button>
                <button onclick="saveStrategy()" class="btn-save">ç¢ºèªå„²å­˜åˆ°æ•¸æ“šåº«</button>
            </div>
        </div>
    </div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        let currentData = [];
        let availableDates = [];
        let generatedPicks = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // Fetch available dates first
            try {
                const response = await fetch('/api/speedpro/dates');
                const data = await response.json();
                if (data.success) {
                    availableDates = data.dates; // Expecting ['YYYY-MM-DD', ...]
                    initDatePicker();
                }
            } catch (e) {
                console.error("Failed to fetch dates", e);
                initDatePicker(); // Init anyway
            }
        });

        function initDatePicker() {
            flatpickr("#datePicker", {
                dateFormat: "Y-m-d",
                onDayCreate: function(dObj, dStr, fp, dayElem) {
                    const dateStr = formatDate(dayElem.dateObj);
                    if (availableDates.includes(dateStr)) {
                        dayElem.className += " has-data";
                        dayElem.title = "æœ‰æ•¸æ“š";
                    }
                },
                defaultDate: availableDates.length > 0 ? availableDates[0] : null
            });
            
            if (availableDates.length > 0) {
                fetchData();
            }
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function fetchData() {
            const dateStr = document.getElementById('datePicker').value;
            if (!dateStr) return;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                const response = await fetch(`/api/speedpro/data?date=${dateStr}`);
                const result = await response.json();
                
                if (result.success) {
                    currentData = result.data.map(item => {
                        const assess = parseFloat(item.assessment) || 0;
                        const req = parseFloat(item.energyReq) || 0;
                        const diff = (assess - req).toFixed(2);
                        
                        return {
                            ...item,
                            diff: parseFloat(diff),
                            assessVal: assess,
                            reqVal: req,
                            statusVal: item.statusRating || 0
                        };
                    });
                    renderTable();
                    document.getElementById('results').style.display = 'block';
                } else {
                    alert('æ²’æœ‰æ‰¾åˆ°æ•¸æ“š: ' + result.message);
                }
            } catch (error) {
                alert('è¼‰å…¥å¤±æ•—: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderTable() {
            const container = document.getElementById('results');
            container.innerHTML = '';

            const sort1 = document.getElementById('sort1').value;
            const sort2 = document.getElementById('sort2').value;
            const sort3 = document.getElementById('sort3').value;

            // Group by Race
            const races = {};
            currentData.forEach(row => {
                if (!races[row.raceNo]) races[row.raceNo] = [];
                races[row.raceNo].push(row);
            });

            const raceNos = Object.keys(races).map(Number).sort((a, b) => a - b);

            if (raceNos.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">æš«ç„¡æ•¸æ“š</div>';
                return;
            }

            raceNos.forEach(raceNo => {
                const raceData = races[raceNo];

                // Sort race data
                raceData.sort((a, b) => {
                    const criteria = [sort1, sort2, sort3];
                    
                    for (let col of criteria) {
                        if (col === 'none') continue;
                        
                        let valA = a[col];
                        let valB = b[col];
                        
                        if (col === 'assessment') { valA = a.assessVal; valB = b.assessVal; }
                        else if (col === 'energyReq') { valA = a.reqVal; valB = b.reqVal; }
                        else if (col === 'statusRating') { valA = a.statusVal; valB = b.statusVal; }
                        else if (col === 'difference') { valA = a.diff; valB = b.diff; }
                        
                        let isDesc = ['statusRating', 'difference', 'assessment', 'energyReq'].includes(col);
                        
                        if (valA < valB) return isDesc ? 1 : -1;
                        if (valA > valB) return isDesc ? -1 : 1;
                    }
                    return 0;
                });

                // Update currentData order in memory implicitly? No, currentData is flat. 
                // We are sorting the group. This is what we display.

                // Create Section
                const section = document.createElement('div');
                section.className = 'race-section';
                section.dataset.raceId = raceData[0].raceId; // Store raceId for Lab
                section.dataset.raceNo = raceNo;
                
                const title = document.createElement('div');
                title.className = 'race-title';
                title.textContent = `ç¬¬ ${raceNo} å ´`;
                section.appendChild(title);

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th onclick="updateSort('horseNo')">é¦¬è™Ÿ</th>
                            <th>é¦¬å</th>
                            <th onclick="updateSort('draw')">æª”ä½</th>
                            <th onclick="updateSort('assessment')">é€Ÿå‹¢èƒ½é‡è©•ä¼°</th>
                            <th onclick="updateSort('statusRating')">é¦¬åŒ¹ç‹€æ…‹</th>
                            <th onclick="updateSort('energyReq')">æ‰€éœ€èƒ½é‡</th>
                            <th onclick="updateSort('difference')">é€Ÿå‹¢èƒ½é‡ç›¸å·®å€¼</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                
                table.querySelectorAll('th').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                    if (th.getAttribute('onclick')?.includes(`'${sort1}'`)) {
                        th.classList.add(['statusRating', 'difference', 'assessment', 'energyReq'].includes(sort1) ? 'sort-desc' : 'sort-asc');
                    }
                });

                raceData.forEach(row => {
                    let diffClass = 'val-neutral';
                    if (row.diff > 0) diffClass = 'val-pos';
                    else if (row.diff < 0) diffClass = 'val-neg';
                    const diffDisplay = row.diff > 0 ? `+${row.diff}` : `${row.diff}`;

                    let statusClass = 'val-neutral';
                    let statusDisplay = '-';
                    if (row.statusRating > 0) {
                        statusClass = 'val-pos';
                        statusDisplay = `+${row.statusRating}`;
                    } else if (row.statusRating < 0) {
                        statusClass = 'val-neg';
                        statusDisplay = `${row.statusRating}`;
                    }

                    const tr = document.createElement('tr');
                    tr.dataset.horseNo = row.horseNo; // For picking
                    tr.innerHTML = `
                        <td>${row.horseNo}</td>
                        <td style="text-align: left; padding-left: 20px;">${row.horseName}</td>
                        <td>${row.draw || '-'}</td>
                        <td>${row.assessment || '-'}</td>
                        <td class="${statusClass}">${statusDisplay}</td>
                        <td>${row.energyReq || '-'}</td>
                        <td class="${diffClass}">${diffDisplay}</td>
                    `;
                    tbody.appendChild(tr);
                });

                section.appendChild(table);
                container.appendChild(section);
            });
        }

        function applyMultiSort() {
            renderTable();
        }

        function updateSort(col) {
            document.getElementById('sort1').value = col;
            document.getElementById('sort2').value = 'none';
            document.getElementById('sort3').value = 'none';
            renderTable();
        }

        // --- Lab Functions ---

        function generatePreview() {
            const name = document.getElementById('strategyName').value;
            if (!name) {
                alert('è«‹è¼¸å…¥ç­–ç•¥åç¨±');
                return;
            }

            generatedPicks = [];
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = '';

            const sections = document.querySelectorAll('.race-section');
            if (sections.length === 0) {
                alert('æ²’æœ‰æ•¸æ“šå¯ç”Ÿæˆ');
                return;
            }

            sections.forEach(section => {
                const raceNo = section.dataset.raceNo;
                const raceId = section.dataset.raceId;
                const rows = section.querySelectorAll('tbody tr');
                
                // Get top 6
                const picks = [];
                for(let i=0; i<rows.length && i<6; i++) {
                    const horseNo = parseInt(rows[i].dataset.horseNo);
                    picks.push(horseNo);
                }

                generatedPicks.push({
                    raceId: raceId,
                    raceNo: raceNo,
                    picks: picks
                });

                // Add to preview UI
                const item = document.createElement('div');
                item.className = 'preview-item';
                item.innerHTML = `
                    <span style="color: var(--accent-gold); font-weight: bold;">ç¬¬ ${raceNo} å ´</span>
                    <span>${picks.join(', ')}</span>
                `;
                previewContent.appendChild(item);
            });

            document.getElementById('previewModal').style.display = 'flex';
        }

        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }

        async function saveStrategy() {
            const name = document.getElementById('strategyName').value;
            const sort1 = document.getElementById('sort1').value;
            const sort2 = document.getElementById('sort2').value;
            const sort3 = document.getElementById('sort3').value;
            
            const criteria = {
                sort1, sort2, sort3
            };

            const payload = {
                name: name,
                criteria: criteria,
                picks: generatedPicks.map(p => ({
                    raceId: p.raceId,
                    picks: p.picks
                }))
            };

            try {
                const btn = document.querySelector('.btn-save');
                const originalText = btn.textContent;
                btn.textContent = 'å„²å­˜ä¸­...';
                btn.disabled = true;

                const response = await fetch('/api/strategies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('ç­–ç•¥å·²æˆåŠŸå„²å­˜ï¼');
                    closePreview();
                } else {
                    alert('å„²å­˜å¤±æ•—: ' + result.message);
                }
                
                btn.textContent = originalText;
                btn.disabled = false;
            } catch (error) {
                alert('å„²å­˜éŒ¯èª¤: ' + error.message);
                document.querySelector('.btn-save').disabled = false;
            }
        }
    </script>
</body>
</html>
