<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= horseName %> (<%= horseId %>) - ÂæÄÁ∏æÁ¥ÄÈåÑ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #2d2d2d;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-gold: #fbbf24;
            --accent-green: #10b981;
            --accent-blue: #3b82f6;
            --border-color: #404040;
            --table-header-bg: #333333;
            --table-row-even: #252525;
            --table-row-odd: #2a2a2a;
        }

        body { 
            font-family: 'Roboto', 'Segoe UI', Tahoma, sans-serif; 
            padding: 20px; 
            background-color: var(--bg-dark); 
            color: var(--text-main);
            margin: 0; 
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { 
            color: var(--accent-gold); 
            margin: 0;
            font-size: 2em;
        }

        .btn-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-link:hover { text-decoration: underline; color: #60a5fa; }

        .chart-container {
            background: var(--bg-panel);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            height: 400px;
        }

        .table-container {
            background: var(--bg-panel);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        th {
            background-color: var(--table-header-bg);
            color: var(--accent-gold);
            padding: 0; /* Reset padding for full-height interaction */
            text-align: left;
            font-weight: 600;
            position: relative; /* For dropdown positioning */
            user-select: none;
        }

        .th-content {
            padding: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
        }
        .th-content:hover {
            background-color: #404040;
        }
        .th-content.active-filter {
            color: var(--accent-blue);
            background-color: #383838;
        }

        .filter-icon {
            font-size: 0.8em;
            opacity: 0.5;
        }
        .active-filter .filter-icon {
            opacity: 1;
            color: var(--accent-blue);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            min-width: 150px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
        }
        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            color: var(--text-main);
            transition: background 0.2s;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item:hover {
            background-color: #404040;
        }
        .dropdown-item.selected {
            background-color: var(--accent-blue);
            color: white;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-main);
        }

        tr:nth-child(even) { background-color: var(--table-row-even); }
        tr:nth-child(odd) { background-color: var(--table-row-odd); }
        tr:hover { background-color: #383838; }

        .rank-1 { color: #fbbf24; font-weight: bold; }
        .rank-2 { color: #9ca3af; font-weight: bold; }
        .rank-3 { color: #b45309; font-weight: bold; }

        .filter-bar {
            background: var(--bg-panel);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-item label {
            color: var(--text-muted);
            font-size: 0.85em;
        }
        .filter-item select {
            background: var(--bg-dark);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 4px;
            min-width: 120px;
        }

        .profile-info-panel {
            background: var(--bg-panel);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px 25px;
        }
        .profile-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .profile-item .label {
            color: var(--text-muted);
            font-size: 0.85em;
        }
        .profile-item .value {
            color: var(--text-main);
            font-size: 1em;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            h1 { font-size: 1.5em; }
            
            .chart-container {
                padding: 10px;
                height: 300px;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 800px;
            }
            
            .table-container::after {
                content: '‚Üê Â∑¶Âè≥ÊªëÂãïÊü•ÁúãÊõ¥Â§ö ‚Üí';
                display: block;
                text-align: center;
                color: var(--text-muted);
                font-size: 0.8em;
                margin-top: 5px;
                padding-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1><%= horseName %> (<%= horseId %>)</h1>
                <p style="color: var(--text-muted); margin: 5px 0 0 0;">ÊâÄÊúâÂæÄÁ∏æÁ¥ÄÈåÑ</p>
            </div>
            <a href="/scrape-data" class="btn-link">
                <span>üîô</span> ËøîÂõûÊéí‰ΩçË°®
            </a>
        </div>

        <% if (locals.profile) { %>
        <div class="profile-info-panel">
            <div class="profile-grid">
                <div class="profile-item">
                    <span class="label">Âá∫ÁîüÂú∞ / È¶¨ÈΩ°</span>
                    <span class="value"><%= profile.origin || '-' %> / <%= profile.age || '-' %></span>
                </div>
                <div class="profile-item">
                    <span class="label">ÊØõËâ≤ / ÊÄßÂà•</span>
                    <span class="value"><%= profile.color || '-' %> / <%= profile.sex || '-' %></span>
                </div>
                <div class="profile-item">
                    <span class="label">ÈÄ≤Âè£È°ûÂà•</span>
                    <span class="value"><%= profile.importType || '-' %></span>
                </div>
                <div class="profile-item">
                    <span class="label">Á∑¥È¶¨Â∏´</span>
                    <span class="value"><%= profile.trainer || '-' %></span>
                </div>
                <div class="profile-item">
                    <span class="label">Â≠£ÂÖßÁçéÈáë</span>
                    <span class="value"><%= profile.seasonStakes || '-' %></span>
                </div>
                <div class="profile-item">
                    <span class="label">Á∏ΩÁçéÈáë</span>
                    <span class="value"><%= profile.totalStakes || '-' %></span>
                </div>
                <div class="profile-item">
                    <span class="label">ÂÜ†-‰∫û-Â≠£-Á∏ΩÂá∫Ë≥ΩÊ¨°Êï∏</span>
                    <span class="value"><%= profile.record || '-' %></span>
                </div>
                <div class="profile-item">
                    <span class="label">Áà∂Á≥ª</span>
                    <span class="value"><%= profile.sire || '-' %></span>
                </div>
                <div class="profile-item">
                    <span class="label">ÊØçÁ≥ª</span>
                    <span class="value"><%= profile.dam || '-' %></span>
                </div>
                <div class="profile-item">
                    <span class="label">Â§ñÁ•ñÁà∂</span>
                    <span class="value"><%= profile.damSire || '-' %></span>
                </div>
                <div class="profile-item" style="grid-column: 1 / -1;">
                    <span class="label">È¶¨‰∏ª</span>
                    <span class="value"><%= profile.owner || '-' %></span>
                </div>
            </div>
        </div>
        <% } %>

        <div class="chart-container">
            <canvas id="performanceChart"></canvas>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Â†¥Ê¨°</th>
                        
                        <!-- Rank Filter -->
                        <th>
                            <div class="th-content" onclick="toggleDropdown(event, 'rank')">
                                ÂêçÊ¨° <span id="icon-rank" class="filter-icon">‚ñº</span>
                            </div>
                            <div id="dropdown-rank" class="dropdown-menu">
                                <div class="dropdown-item selected" onclick="setFilter('rank', '')">ÂÖ®ÈÉ® (All)</div>
                                <div class="dropdown-item" onclick="setFilter('rank', 'top3')">Ââç 3 Âêç (Top 3)</div>
                            </div>
                        </th>

                        <th>Êó•Êúü</th>

                        <!-- Distance Filter -->
                        <th>
                            <div class="th-content" onclick="toggleDropdown(event, 'distance')">
                                Ë∑ØÁ®ã <span id="icon-distance" class="filter-icon">‚ñº</span>
                            </div>
                            <div id="dropdown-distance" class="dropdown-menu"></div>
                        </th>

                        <!-- Venue Filter -->
                        <th>
                            <div class="th-content" onclick="toggleDropdown(event, 'venue')">
                                Â†¥Âú∞ <span id="icon-venue" class="filter-icon">‚ñº</span>
                            </div>
                            <div id="dropdown-venue" class="dropdown-menu"></div>
                        </th>

                        <!-- Class Filter -->
                        <th>
                            <div class="th-content" onclick="toggleDropdown(event, 'class')">
                                Áè≠Ê¨° <span id="icon-class" class="filter-icon">‚ñº</span>
                            </div>
                            <div id="dropdown-class" class="dropdown-menu"></div>
                        </th>

                        <th>Ê™î‰Ωç</th>

                        <!-- Jockey Filter -->
                        <th>
                            <div class="th-content" onclick="toggleDropdown(event, 'jockey')">
                                È®éÂ∏´ <span id="icon-jockey" class="filter-icon">‚ñº</span>
                            </div>
                            <div id="dropdown-jockey" class="dropdown-menu"></div>
                        </th>

                        <!-- Trainer Filter -->
                        <th>
                            <div class="th-content" onclick="toggleDropdown(event, 'trainer')">
                                Á∑¥È¶¨Â∏´ <span id="icon-trainer" class="filter-icon">‚ñº</span>
                            </div>
                            <div id="dropdown-trainer" class="dropdown-menu"></div>
                        </th>

                        <th>Ë©ïÂàÜ</th>
                        <th>Ë≤†Á£Ö</th>
                        <th>Áç®Ë¥è</th>
                    </tr>
                </thead>
                <tbody id="records-body">
                    <% records.forEach(function(record) { 
                        // Skip header row if present in data
                        if (record.raceIndex === 'Â†¥Ê¨°') return;
                    %>
                        <tr>
                            <td><%= record.raceIndex %></td>
                            <td class="rank-<%= record.rank %>"><%= record.rank %></td>
                            <td><%= record.date %></td>
                            <td><%= record.distance %></td>
                            <td><%= record.venue %></td>
                            <td><%= record.class %></td>
                            <td><%= record.draw %></td>
                            <td><%= record.jockey %></td>
                            <td><%= record.trainer %></td>
                            <td><%= record.rating %></td>
                            <td><%= record.weight %></td>
                            <td><%= record.odds %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Prepare data
        let allRecords = <%- JSON.stringify(records) %>;
        // Clean data: remove header rows if scraped by mistake
        allRecords = allRecords.filter(r => r.raceIndex !== 'Â†¥Ê¨°' && r.rank !== 'ÂêçÊ¨°');

        const ctx = document.getElementById('performanceChart').getContext('2d');
        let chart;

        // Active filters state
        const activeFilters = {
            rank: '',
            distance: '',
            venue: '',
            class: '',
            jockey: '',
            trainer: ''
        };

        function init() {
            populateFilters();
            updateChart(allRecords);
            
            // Global click listener to close dropdowns
            document.addEventListener('click', (e) => {
                if (!e.target.closest('th')) {
                    closeAllDropdowns();
                }
            });
        }

        function populateFilters() {
            const getUnique = (key) => [...new Set(allRecords.map(r => r[key]).filter(Boolean))].sort();
            
            const distances = getUnique('distance');
            const venues = getUnique('venue');
            const classes = getUnique('class');
            const jockeys = getUnique('jockey');
            const trainers = getUnique('trainer');

            // Helper to create dropdown items
            const fillDropdown = (id, key, opts) => {
                const container = document.getElementById(id);
                // Clear but keep "All" option if it exists (for Rank hardcoded one)
                // For dynamic ones, we recreate "All"
                container.innerHTML = '';

                // Add "All" option
                const allItem = document.createElement('div');
                allItem.className = 'dropdown-item selected';
                allItem.textContent = 'ÂÖ®ÈÉ® (All)';
                allItem.onclick = () => setFilter(key, '');
                container.appendChild(allItem);

                opts.forEach(opt => {
                    const el = document.createElement('div');
                    el.className = 'dropdown-item';
                    el.textContent = opt;
                    el.onclick = () => setFilter(key, opt);
                    container.appendChild(el);
                });
            };

            fillDropdown('dropdown-distance', 'distance', distances);
            fillDropdown('dropdown-venue', 'venue', venues);
            fillDropdown('dropdown-class', 'class', classes);
            fillDropdown('dropdown-jockey', 'jockey', jockeys);
            fillDropdown('dropdown-trainer', 'trainer', trainers);
        }

        function toggleDropdown(event, key) {
            event.stopPropagation();
            const dropdown = document.getElementById(`dropdown-${key}`);
            const isShown = dropdown.classList.contains('show');
            
            closeAllDropdowns();
            
            if (!isShown) {
                dropdown.classList.add('show');
            }
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-menu').forEach(el => el.classList.remove('show'));
        }

        function setFilter(key, value) {
            activeFilters[key] = value;
            
            // Update UI
            updateFilterUI(key, value);
            closeAllDropdowns();
            applyFilters();
        }

        function updateFilterUI(key, value) {
            // Update Icon and Header Style
            const icon = document.getElementById(`icon-${key}`);
            const thContent = icon.parentElement;
            
            if (value) {
                thContent.classList.add('active-filter');
                icon.textContent = '‚òÖ'; // Filter active icon
            } else {
                thContent.classList.remove('active-filter');
                icon.textContent = '‚ñº';
            }

            // Update Selected Item in Dropdown
            const dropdown = document.getElementById(`dropdown-${key}`);
            Array.from(dropdown.children).forEach(item => {
                if ((value === '' && item.textContent.includes('ÂÖ®ÈÉ®')) || item.textContent === value) {
                    item.classList.add('selected');
                } else if (key === 'rank' && value === 'top3' && item.textContent.includes('Top 3')) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function applyFilters() {
            const filtered = allRecords.filter(r => {
                if (activeFilters.rank === 'top3') {
                    const rank = parseInt(r.rank);
                    if (isNaN(rank) || rank > 3) return false;
                }
                if (activeFilters.distance && r.distance !== activeFilters.distance) return false;
                if (activeFilters.venue && r.venue !== activeFilters.venue) return false;
                if (activeFilters.class && r.class !== activeFilters.class) return false;
                if (activeFilters.jockey && r.jockey !== activeFilters.jockey) return false;
                if (activeFilters.trainer && r.trainer !== activeFilters.trainer) return false;
                return true;
            });

            renderTable(filtered);
            updateChart(filtered);
        }

        function resetFilters() {
            Object.keys(activeFilters).forEach(key => {
                setFilter(key, '');
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('records-body');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; padding: 20px;">Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁ¥ÄÈåÑ</td></tr>';
                return;
            }

            data.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.raceIndex}</td>
                    <td class="rank-${r.rank}">${r.rank}</td>
                    <td>${r.date}</td>
                    <td>${r.distance}</td>
                    <td>${r.venue}</td>
                    <td>${r.class}</td>
                    <td>${r.draw || '-'}</td>
                    <td>${r.jockey}</td>
                    <td>${r.trainer}</td>
                    <td>${r.rating}</td>
                    <td>${r.weight}</td>
                    <td>${r.odds}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateChart(data) {
            // Chart expects chronological order (oldest -> newest)
            const chronoData = [...data].reverse();
            
            // Filter out records with invalid ranks (e.g., WV, PU) to avoid gaps in the chart
            const validData = chronoData.filter(r => !isNaN(parseInt(r.rank)));

            const labels = validData.map(r => r.date);
            const ranks = validData.map(r => parseInt(r.rank));

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ÂêçÊ¨° (Rank)',
                        data: ranks,
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#fbbf24',
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        tension: 0.1,
                        fill: true,
                        spanGaps: true // Ensure lines connect even if we missed some data points
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            reverse: true, // Rank 1 is at top
                            beginAtZero: false,
                            min: 1,
                            max: 14, // Assuming max 14 horses usually
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                stepSize: 1,
                                color: '#a0a0a0'
                            },
                            title: {
                                display: true,
                                text: 'ÂêçÊ¨°',
                                color: '#a0a0a0'
                            }
                        },
                        x: {
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#a0a0a0'
                            },
                            title: {
                                display: true,
                                text: 'Êó•Êúü',
                                color: '#a0a0a0'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const r = validData[index];
                                    return `ÂêçÊ¨°: ${r.rank} (Â†¥Ê¨°: ${r.raceIndex}, Ë∑ùÈõ¢: ${r.distance})`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize
        init();
    </script>
</body>
</html>
