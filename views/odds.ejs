<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>實時賠率監控 - HKJC Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --hkjc-blue: #003e7e;
            --hkjc-yellow: #ffde00;
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent-gold: #ffd700;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background-color: #000;
            border-bottom: 2px solid var(--accent-gold);
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid #333;
            margin-bottom: 20px;
        }

        .btn-hkjc {
            background-color: var(--hkjc-blue);
            color: white;
            border: 1px solid var(--hkjc-yellow);
        }
        .btn-hkjc:hover {
            background-color: #002d5e;
            color: var(--hkjc-yellow);
        }

        .odds-table {
            width: 100%;
            border-collapse: collapse;
        }
        .odds-table th, .odds-table td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #333;
        }
        .odds-table th {
            background-color: #2c2c2c;
            color: var(--accent-gold);
        }
        
        .odds-value {
            font-weight: bold;
            color: #4caf50;
        }
        .odds-drop {
            font-size: 0.8em;
            color: #ff5252;
        }
        .favourite {
            background-color: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--accent-gold);
            border-radius: 4px;
            padding: 2px 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-horse-head me-2" style="color: var(--accent-gold);"></i>
                HKJC Analysis
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/">主頁</a></li>
                    <li class="nav-item"><a class="nav-link" href="/scrape-data">馬匹數據</a></li>
                    <li class="nav-item"><a class="nav-link" href="/analysis">數據分析</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/odds">實時賠率</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card p-3">
                    <h5 class="card-title mb-3"><i class="fas fa-filter me-2"></i>查詢條件</h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">日期</label>
                            <input type="date" class="form-control bg-dark text-white" id="dateInput" value="2026-02-01">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">場地</label>
                            <select class="form-select bg-dark text-white" id="venueInput">
                                <option value="ST">沙田 (ST)</option>
                                <option value="HV">跑馬地 (HV)</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">場次</label>
                            <select class="form-select bg-dark text-white" id="raceNoInput">
                                <% for(let i=1; i<=10; i++) { %>
                                    <option value="<%= i %>">第 <%= i %> 場</option>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-hkjc w-100" onclick="fetchOdds()">
                                <i class="fas fa-search me-2"></i>獲取賠率
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultsArea" class="row">
            <!-- Results will be injected here -->
            <div class="col-12 text-center text-muted">
                請選擇日期並點擊獲取賠率...
            </div>
        </div>
    </div>

    <script>
        async function fetchOdds() {
            const date = document.getElementById('dateInput').value;
            const venue = document.getElementById('venueInput').value;
            const raceNo = document.getElementById('raceNoInput').value;

            const resultsArea = document.getElementById('resultsArea');
            resultsArea.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-warning" role="status"></div><div class="mt-2">正在從 HKJC 獲取實時數據...</div></div>';

            try {
                const response = await fetch(`/api/odds?date=${date}&venueCode=${venue}&raceNo=${raceNo}`);
                const data = await response.json();

                if (data.error) {
                    resultsArea.innerHTML = `<div class="col-12"><div class="alert alert-danger">${data.error}</div></div>`;
                    return;
                }

                if (!data.pools || data.pools.length === 0) {
                    resultsArea.innerHTML = `<div class="col-12"><div class="alert alert-warning">找不到該場賽事的賠率數據。可能尚未開售。</div></div>`;
                    return;
                }

                let html = '';
                
                // Group by Odds Type
                data.pools.forEach(pool => {
                    html += `
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 text-warning">${pool.oddsType} (${pool.status})</h5>
                                    <small class="text-muted">更新: ${pool.lastUpdateTime || 'N/A'}</small>
                                </div>
                                <div class="card-body p-0 table-responsive" style="max-height: 400px;">
                                    <table class="odds-table table-dark table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>組合</th>
                                                <th>賠率</th>
                                                <th>落飛</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;

                    if (pool.oddsNodes && pool.oddsNodes.length > 0) {
                        pool.oddsNodes.forEach(node => {
                            const isFav = node.hotFavourite ? 'favourite' : '';
                            html += `
                                <tr>
                                    <td><span class="badge bg-secondary">${node.combString}</span></td>
                                    <td><span class="odds-value ${isFav}">${node.oddsValue}</span></td>
                                    <td>${node.oddsDropValue ? '<span class="odds-drop">↓' + node.oddsDropValue + '</span>' : '-'}</td>
                                </tr>
                            `;
                        });
                    } else {
                        html += `<tr><td colspan="3" class="text-center text-muted py-3">暫無賠率數據</td></tr>`;
                    }

                    html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                });

                resultsArea.innerHTML = html;

            } catch (error) {
                console.error(error);
                resultsArea.innerHTML = `<div class="col-12"><div class="alert alert-danger">請求失敗: ${error.message}</div></div>`;
            }
        }
        
        // Auto-set today's date if possible, or default to next race day
        // document.getElementById('dateInput').valueAsDate = new Date();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
