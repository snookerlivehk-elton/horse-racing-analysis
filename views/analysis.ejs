<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³½äº‹è©•åˆ†åˆ†æ | <%= race.hkjcId %></title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #2d2d2d;
            --text-main: #e0e0e0;
            --accent-gold: #fbbf24;
            --accent-green: #10b981;
            --border: #404040;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: 320px;
            background: #111;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border);
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--bg-panel);
        }
        h2 { color: var(--accent-gold); margin-top: 0; }
        
        /* Table Styles */
        .score-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .score-table th, .score-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        .score-table th {
            background: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .rank-1 { color: #FFD700; font-weight: bold; }
        .rank-2 { color: #C0C0C0; font-weight: bold; }
        .rank-3 { color: #CD7F32; font-weight: bold; }
        
        /* Slider Styles */
        .control-group {
            margin-bottom: 15px;
            background: #222;
            padding: 10px;
            border-radius: 4px;
        }
        .control-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        input[type=range] {
            width: 100%;
        }
        .val-display {
            color: var(--accent-green);
            font-weight: bold;
        }
        
        /* Buttons */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background: var(--accent-gold); color: #000; }
        .btn-secondary { background: #444; color: white; }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-sm { padding: 4px 8px; font-size: 0.8em; }
        
        /* Modal */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
        }
        .modal-content {
            background-color: var(--bg-panel);
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid var(--border);
            width: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #aaa; }
        .form-group input { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: white; box-sizing: border-box; }
    </style>
</head>
<body>

    <!-- Sidebar: Weight Controls -->
    <div class="sidebar">
        <h3>âš–ï¸ æ¬Šé‡èª¿æ•´ (Weights)</h3>
        <div style="margin-bottom: 10px; font-size: 0.8em; color: #888;">
            å³æ™‚èª¿æ•´æ¬Šé‡ä»¥è§€å¯Ÿæ’åè®ŠåŒ–ã€‚
            <br>ç¸½æ¬Šé‡: <span id="total-weight">100</span>%
        </div>
        
        <div id="controls-container">
            <!-- Controls injected by JS -->
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button onclick="autoBalanceWeights()" class="btn btn-success" style="flex: 1;">âš–ï¸ è‡ªå‹•å¹³è¡¡</button>
            <button onclick="saveConfig()" class="btn btn-primary" style="flex: 1;">ğŸ’¾ å„²å­˜</button>
            <button onclick="resetWeights()" class="btn btn-secondary" style="flex: 1;">â†º é‡ç½®</button>
        </div>
    </div>

    <!-- Main: Scoreboard -->
    <div class="main-content">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <a href="/" style="color: #aaa; text-decoration: none;">&larr; å›é¦–é </a>
                <h2>è³½äº‹åˆ†æ: <%= race.date %> <%= race.venue %> Race <%= race.raceNo %></h2>
                <div style="color: #888; font-size: 0.9em;">
                    <%= race.distance %>M | <%= race.class || 'Class ?' %> | <%= race.course || '' %>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="exportToPDF()" class="btn btn-secondary">ğŸ“„ åŒ¯å‡º PDF</button>
                <a href="/api/analysis/export/<%= race.hkjcId %>" target="_blank" class="btn btn-secondary">ğŸ“Š åŒ¯å‡º Excel</a>
                <button onclick="window.location.reload()" class="btn btn-primary">ğŸ”„ é‡æ–°è¨ˆç®—</button>
            </div>
        </header>

        <table class="score-table">
            <thead>
                <tr id="table-header">
                    <th>æ’å</th>
                    <th>é¦¬è™Ÿ</th>
                    <th>é¦¬å</th>
                    <th>ç¸½åˆ†</th>
                    <!-- Factor columns injected by JS -->
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="score-body">
                <!-- Rows injected by JS -->
            </tbody>
        </table>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">æ‰‹å‹•ä¿®æ­£</h3>
            <input type="hidden" id="editRaceId" value="<%= race.hkjcId %>">
            <input type="hidden" id="editHorseNo">
            
            <div class="form-group">
                <label>ç‹€æ…‹è©•åˆ† (Condition Score, 1-10)</label>
                <input type="number" id="editCondition" min="1" max="10" step="0.1" placeholder="é è¨­: 1.0">
                <small style="color: #666;">è¦†è“‹ç³»çµ±é è¨­çš„ç‹€æ…‹åˆ†ã€‚</small>
            </div>
            
            <div class="form-group">
                <label>æ‰‹å‹•åŠ æ¸›åˆ† (Manual Points)</label>
                <input type="number" id="editManualPoints" step="0.1" placeholder="0.0">
                <small style="color: #666;">ç›´æ¥åŠ æ¸›ç¸½åˆ† (ä¾‹å¦‚: +2.5 æˆ– -1.0)ã€‚</small>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="closeModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="saveAdjustment()" class="btn btn-primary">å„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // Data passed from server
        const scores = <%- JSON.stringify(scores) %>;
        let config = <%- JSON.stringify(config) %>;
        const initialWeights = {};
        
        // Helper to find adjustment data (if any)
        // Since we don't pass raw adjustments, we infer from breakdown
        // Actually, we should pass adjustments separately or look at specific breakdown fields
        
        function init() {
            const controls = document.getElementById('controls-container');
            const headerRow = document.getElementById('table-header');
            
            if (scores.length > 0) {
                const keys = Object.keys(scores[0].breakdown).filter(k => k !== 'manual_adjustment'); // Filter out manual item from columns if needed, but we usually want to show it.
                // Actually manual_adjustment is in breakdown if it exists.
                
                // We only want sliders for Configured Factors
                const configKeys = Object.keys(config.factors);
                
                configKeys.forEach(key => {
                    const factorConfig = config.factors[key];
                    const weight = factorConfig.weight;
                    initialWeights[key] = weight;

                    // Create Slider
                    const div = document.createElement('div');
                    div.className = 'control-group';
                    div.innerHTML = `
                        <div class="control-header">
                            <span>${key}</span> <!-- Label would be better but key is fine for now -->
                            <span class="val-display" id="val-${key}">${weight}%</span>
                        </div>
                        <input type="range" min="0" max="50" step="0.1" value="${weight}" 
                               oninput="updateWeight('${key}', this.value)">
                    `;
                    controls.appendChild(div);
                });

                // Add Headers for ALL breakdown items (including manual)
                // Get union of all keys from all horses to be safe, or just first horse
                const allKeys = new Set();
                scores.forEach(s => Object.keys(s.breakdown).forEach(k => allKeys.add(k)));
                
                // Sort keys to match config order + others
                const sortedKeys = Array.from(allKeys).sort((a, b) => {
                   // Put manual_adjustment last
                   if (a === 'manual_adjustment') return 1;
                   if (b === 'manual_adjustment') return -1;
                   return 0;
                });

                sortedKeys.forEach(key => {
                    const th = document.createElement('th');
                    // Try to get label from first horse that has it
                    const sample = scores.find(s => s.breakdown[key]);
                    const label = sample ? sample.breakdown[key].factorLabel : key;
                    
                    th.innerText = label.substring(0, 4);
                    th.title = label;
                    headerRow.appendChild(th);
                });
                
                // Save sorted keys for renderTable
                window.tableKeys = sortedKeys;
            }

            renderTable();
            updateTotalWeight();
        }

        function renderTable() {
            const tbody = document.getElementById('score-body');
            tbody.innerHTML = '';

            // Sort scores by totalScore desc
            const sortedScores = [...scores].sort((a, b) => b.totalScore - a.totalScore);

            sortedScores.forEach((s, index) => {
                const tr = document.createElement('tr');
                
                // Rank Class
                let rankClass = '';
                if (index === 0) rankClass = 'rank-1';
                if (index === 1) rankClass = 'rank-2';
                if (index === 2) rankClass = 'rank-3';

                // Find Condition Score for Edit Modal Pre-fill
                // It's hidden in breakdown.condition.rawScore usually
                // But we can't easily distinguish manual vs auto raw score here without extra data.
                // However, the user just wants to overwrite it.
                
                tr.innerHTML = `
                    <td class="${rankClass}">${index + 1}</td>
                    <td>${s.horseNo}</td>
                    <td style="text-align: left;">${s.horseName}</td>
                    <td style="font-weight: bold; color: var(--accent-gold);">${s.totalScore.toFixed(1)}</td>
                `;

                // Render Factor Columns
                if (window.tableKeys) {
                    window.tableKeys.forEach(key => {
                        const item = s.breakdown[key];
                        const val = item ? item.weightedScore.toFixed(1) : '-';
                        // Highlight manual adjustment
                        const style = key === 'manual_adjustment' ? 'color: var(--accent-green); font-weight: bold;' : '';
                        tr.innerHTML += `<td style="${style}">${val}</td>`;
                    });
                }

                // Action Column
                tr.innerHTML += `
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="openEditModal(${s.horseNo}, '${s.horseName}')">âœï¸</button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        function updateWeight(key, val) {
            val = parseFloat(val);
            if (config.factors[key]) {
                config.factors[key].weight = val;
                document.getElementById(`val-${key}`).innerText = val + '%';
                updateTotalWeight();
                // Recalculate scores client-side? 
                // Currently scores are static from server. 
                // We need to re-calculate based on raw scores if we want instant update without reload.
                // BUT, the scores object passed from server has 'weightedScore' pre-calculated.
                // We also need 'rawScore' to re-calculate.
                // Let's check if 'rawScore' is available. Yes, likely.
                recalcScores();
            }
        }

        function recalcScores() {
            // Re-calculate total score based on new weights
            scores.forEach(s => {
                let total = 0;
                Object.keys(s.breakdown).forEach(key => {
                    const item = s.breakdown[key];
                    if (key === 'manual_adjustment') {
                        total += item.weightedScore; // Fixed value
                    } else if (config.factors[key]) {
                        // Update weighted score
                        const weight = config.factors[key].weight;
                        item.weightedScore = (item.rawScore * weight) / 100; // Assuming rawScore is normalized 0-100?
                        // Wait, previous logic might be raw * weight. 
                        // Let's assume rawScore is effectively 0-100 scale (or whatever the engine uses).
                        // If engine uses 0-10, and weight is percentage...
                        // We need to match engine logic. 
                        // Engine: weighted = raw * weight
                        total += item.weightedScore;
                    } else {
                        total += item.weightedScore; // Other factors not in config?
                    }
                });
                s.totalScore = total;
            });
            renderTable();
        }

        function updateTotalWeight() {
            let total = 0;
            Object.keys(config.factors).forEach(key => {
                total += config.factors[key].weight;
            });
            const el = document.getElementById('total-weight');
            el.innerText = total.toFixed(1);
            el.style.color = Math.abs(total - 100) < 0.5 ? '#10b981' : '#ef4444';
        }

        function autoBalanceWeights() {
            let total = 0;
            const keys = Object.keys(config.factors);
            keys.forEach(key => total += config.factors[key].weight);
            
            if (total === 0) return; // Prevent divide by zero

            const factor = 100 / total;
            let newTotal = 0;

            keys.forEach((key, index) => {
                let newWeight = config.factors[key].weight * factor;
                newWeight = Math.round(newWeight * 10) / 10; // Round to 1 decimal
                
                // Adjust last item to ensure exact 100
                if (index === keys.length - 1) {
                    newWeight = 100 - newTotal;
                    newWeight = Math.round(newWeight * 10) / 10;
                } else {
                    newTotal += newWeight;
                }

                config.factors[key].weight = newWeight;
                
                // Update Slider UI
                const input = document.querySelector(`input[oninput="updateWeight('${key}', this.value)"]`);
                if (input) input.value = newWeight;
                document.getElementById(`val-${key}`).innerText = newWeight + '%';
            });

            updateTotalWeight();
            recalcScores();
        }

        function resetWeights() {
            location.reload(); 
        }

        async function saveConfig() {
            try {
                const res = await fetch('/api/config/scoring', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config: config,
                        name: "Auto-Saved Config " + new Date().toLocaleString()
                    })
                });
                if (res.ok) {
                    alert('è¨­å®šå·²å„²å­˜ï¼');
                } else {
                    alert('å„²å­˜å¤±æ•—: ' + (await res.text()));
                }
            } catch (e) {
                alert('å„²å­˜éŒ¯èª¤: ' + e.message);
            }
        }

        // Modal Functions
        function openEditModal(horseNo, horseName) {
            document.getElementById('modalTitle').innerText = `æ‰‹å‹•ä¿®æ­£: ${horseName} (#${horseNo})`;
            document.getElementById('editHorseNo').value = horseNo;
            
            // Try to pre-fill
            const horseScore = scores.find(s => s.horseNo == horseNo);
            if (horseScore) {
                // Condition
                if (horseScore.breakdown.condition) {
                    // This is the tricky part: is rawScore the manual one?
                    // We don't know for sure without extra flags. 
                    // But we can just leave it blank or show current raw.
                    document.getElementById('editCondition').value = horseScore.breakdown.condition.rawScore; 
                }
                // Manual Points
                if (horseScore.breakdown.manual_adjustment) {
                    document.getElementById('editManualPoints').value = horseScore.breakdown.manual_adjustment.rawScore;
                } else {
                    document.getElementById('editManualPoints').value = '';
                }
            }

            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        async function saveAdjustment() {
            const raceId = document.getElementById('editRaceId').value;
            const horseNo = document.getElementById('editHorseNo').value;
            const conditionScore = document.getElementById('editCondition').value;
            const manualPoints = document.getElementById('editManualPoints').value;

            try {
                const res = await fetch('/api/scoring/adjust', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        raceId,
                        horseNo: parseInt(horseNo),
                        conditionScore: conditionScore ? parseFloat(conditionScore) : undefined,
                        manualPoints: manualPoints ? parseFloat(manualPoints) : undefined
                    })
                });
                
                if (res.ok) {
                    // Reload to reflect changes from server
                    location.reload();
                } else {
                    alert('Save failed: ' + (await res.text()));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Close modal if clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        function exportToPDF() {
            // Clone title
            const title = document.querySelector('h2').innerText;
            const subTitle = document.querySelector('.main-content header div').innerText;
            
            // Create container
            const container = document.createElement('div');
            container.style.padding = '20px';
            container.style.background = 'white';
            container.style.color = 'black';
            container.innerHTML = `<h2 style="text-align:center">${title}</h2><p style="text-align:center">${subTitle}</p>`;
            
            // Clone table
            const table = document.querySelector('.score-table').cloneNode(true);
            
            // Style table for PDF
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.color = 'black';
            
            const cells = table.querySelectorAll('th, td');
            cells.forEach(cell => {
                cell.style.border = '1px solid #ccc';
                cell.style.padding = '8px';
                cell.style.color = 'black';
            });

            // Remove "Action" column (last column)
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                if (row.cells.length > 0) {
                    row.deleteCell(-1); 
                }
            });
            
            container.appendChild(table);
            
            const opt = {
                margin:       10,
                filename:     `analysis-${document.querySelector('#editRaceId').value}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, backgroundColor: '#ffffff' },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            
            html2pdf().set(opt).from(container).save();
        }

        // Start
        init();
    </script>
</body>
</html>