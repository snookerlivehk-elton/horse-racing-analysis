// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 基礎賽事資訊 (Race Meeting / Race)
model Race {
  id          String        @id @default(uuid())
  hkjcId      String        @unique // e.g., "20260201-ST-1" (Date-Venue-RaceNo)
  date        String        // YYYY-MM-DD
  venue       String        // ST or HV
  raceNo      Int
  startTime   DateTime?
  
  // Relations
  oddsHistory OddsHistory[]
  results     RaceResult[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@unique([date, venue, raceNo])
}

// 賠率歷史記錄 (Odds Snapshot)
model OddsHistory {
  id          String   @id @default(uuid())
  raceId      String
  race        Race     @relation(fields: [raceId], references: [id])
  timestamp   DateTime @default(now())
  
  // 獨贏賠率 (JSON format: { "1": 5.5, "2": 12.0 ... })
  winOdds     Json?
  
  // 位置賠率 (JSON format: { "1": 1.8, "2": 3.5 ... })
  placeOdds   Json?
  
  // 連贏賠率 (JSON format: { "1-2": 25.0 ... }) - Optional, can be large
  qinOdds     Json?
  
  // 位置Q賠率 (JSON format: { "1-2": 8.5 ... }) - Optional
  qplOdds     Json?

  @@index([raceId, timestamp])
}

// 賽果 (Race Result)
model RaceResult {
  id          String   @id @default(uuid())
  raceId      String
  race        Race     @relation(fields: [raceId], references: [id])
  
  horseNo     Int
  horseName   String?
  place       Int?     // 1, 2, 3, 4...
  finishTime  String?
  jockey      String?
  trainer     String?
  
  createdAt   DateTime @default(now())
}

model Horse {
  id           String             @id @default(uuid())
  hkjcId       String             @unique
  name         String
  
  // Profile Details
  origin       String?
  age          String?
  color        String?
  sex          String?
  importType   String?
  seasonStakes String?
  totalStakes  String?
  record       String?
  sire         String?
  dam          String?
  damSire      String?
  owner        String?
  trainer      String? // Current trainer
  
  performances RacePerformance[]
  trackworks    Trackwork[]
  barrierTrials BarrierTrial[]

  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
}

model RacePerformance {
  id              String   @id @default(uuid())
  horseId         String
  horse           Horse    @relation(fields: [horseId], references: [id])
  
  // Scraped Fields based on HKJC Headers
  raceIndex       String?  // 場次
  place           String?  // 名次
  date            String?  // 日期
  course          String?  // 跑道 (e.g., "A", "C+3")
  distance        String?  // 路程 (e.g., "1200")
  venue           String?  // 場地 (e.g., "ST", "HV")
  class           String?  // 班次 (e.g., "4")
  draw            String?  // 檔位
  rating          String?  // 評分
  trainer         String?  // 練馬師
  jockey          String?  // 騎師
  weight          String?  // 負磅
  winOdds         String?  // 獨贏賠率
  actualWeight    String?  // 實際負磅
  runningPosition String?  // 沿途走位 (e.g. "2 2 1")
  finishTime      String?  // 完成時間
  lbw             String?  // 頭馬距離 (LBW)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([horseId])
  @@index([date])
}

model Trackwork {
  id          String   @id @default(uuid())
  horseId     String
  horse       Horse    @relation(fields: [horseId], references: [id])
  
  date        String   // dd/MM format usually
  type        String   // 踱步, 快操, 游泳, 機操
  venue       String?  // 內圈, 全天候, etc.
  description String?  // Full description e.g. "沙田 內圈 倒快一圈 (助手)"
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([horseId])
  @@index([date])
}

model BarrierTrial {
  id          String   @id @default(uuid())
  horseId     String
  horse       Horse    @relation(fields: [horseId], references: [id])
  
  date        String   // dd/MM
  location    String?  // 沙田, 從化
  venue       String?  // 草地, 全天候
  distance    Int?     // 1000, 1200
  batch       String?  // 第3組
  rank        Int?     // 1
  totalHorses Int?     // 8
  jockey      String?  // 布文
  finishTime  String?  // 1.01.76
  
  raw         String?  // Store full raw string just in case
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([horseId])
}
