
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 基礎賽事資訊 (Race Meeting / Race)
model Race {
  id          String        @id @default(uuid())
  hkjcId      String        @unique // e.g., "20260201-ST-1" (Date-Venue-RaceNo)
  date        String        // YYYY-MM-DD
  venue       String        // ST or HV
  raceNo      Int
  startTime   DateTime?

  // Race Context (Added for Scoring)
  course      String?       // e.g. "Turf - A Course"
  distance    Int?          // e.g. 1200
  class       String?       // e.g. "Class 4" or "4"
  trackType   String?       // e.g. "Turf", "All Weather"
  
  // Relations
  oddsHistory OddsHistory[]
  results     RaceResult[]
  j18Trends   J18Trend[]
  j18Likes    J18Like[]
  j18Payouts  J18Payout[]
  speedPros   SpeedPro[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@unique([date, venue, raceNo])
}

model SpeedPro {
  id              String   @id @default(uuid())
  raceId          String
  race            Race     @relation(fields: [raceId], references: [id])
  
  horseNo         Int
  horseName       String
  draw            Int?
  
  energyReq       String? // 所需能量
  assessment      String? // 速勢能量評估
  
  updatedAt       DateTime @updatedAt

  @@unique([raceId, horseNo])
}

// 賠率歷史記錄 (Odds Snapshot)
model OddsHistory {
  id          String   @id @default(uuid())
  raceId      String
  race        Race     @relation(fields: [raceId], references: [id])
  timestamp   DateTime @default(now())
  
  // 獨贏賠率 (JSON format: { "1": 5.5, "2": 12.0 ... })
  winOdds     Json?
  
  // 位置賠率 (JSON format: { "1": 1.8, "2": 3.5 ... })
  placeOdds   Json?
  
  // 連贏賠率 (JSON format: { "1-2": 25.0 ... }) - Optional, can be large
  qinOdds     Json?
  
  // 位置Q賠率 (JSON format: { "1-2": 8.5 ... }) - Optional
  qplOdds     Json?

  @@index([raceId, timestamp])
}

// 賽果 (Race Result)
model RaceResult {
  id          String   @id @default(uuid())
  raceId      String
  race        Race     @relation(fields: [raceId], references: [id])
  
  horseNo     Int
  horseName   String?
  place       Int?     // 1, 2, 3, 4...
  finishTime  String?
  jockey      String?
  trainer     String?
  rating      String?  // Current rating in this race
  ratingChange String? // Rating +/-
  weight      String?  // Current weight
  draw        String?  // Draw
  gear        String?  // Gear
  
  createdAt   DateTime @default(now())
}

model Horse {
  id           String             @id @default(uuid())
  hkjcId       String             @unique
  name         String
  
  // Profile Details
  origin       String?
  age          String?
  color        String?
  sex          String?
  importType   String?
  seasonStakes String?
  totalStakes  String?
  record       String?
  sire         String?
  dam          String?
  damSire      String?
  owner        String?
  trainer      String? // Current trainer
  
  performances RacePerformance[]
  trackworks   Trackwork[]
  barrierTrials BarrierTrial[]
}

// J18 Data Models

model J18Trend {
  id        String   @id @default(uuid())
  raceId    String
  race      Race     @relation(fields: [raceId], references: [id])
  // Stores the ranking trend for each time point
  // Data structure: { "30": ["3","4"...], "15": [...] }
  trends    Json     
  updatedAt DateTime @updatedAt

  @@unique([raceId])
}

model J18Like {
  id        String   @id @default(uuid())
  raceId    String
  race      Race     @relation(fields: [raceId], references: [id])
  // Stores the recommendations list
  // Data structure: [3, 1, 4, 13, ...]
  recommendations Json 
  updatedAt DateTime @updatedAt
  
  @@unique([raceId])
}

model J18Payout {
  id        String   @id @default(uuid())
  raceId    String
  race      Race     @relation(fields: [raceId], references: [id])
  // Stores the parsed payout information
  payouts   Json    
  updatedAt DateTime @updatedAt
  
  @@unique([raceId])
}

// 馬匹過往出賽紀錄 (Historical Performance)
model RacePerformance {
  id          String   @id @default(uuid())
  horseId     String
  horse       Horse    @relation(fields: [horseId], references: [id])
  
  raceIndex   String?  // Global Race Index (e.g. "294")
  placing     String?  // "1", "2", "12", "WV"...
  date        String?  // dd/mm/yy
  venue       String?  // "ST / Turf / "C+3""
  distance    String?  // "1200"
  going       String?  // "G"
  class       String?  // "4"
  draw        String?
  rating      String?
  trainer     String?
  jockey      String?
  weight      String?
  finishTime  String?
  winOdds     String?
  
  // Sectional Times (Added for Phase 2)
  sectionalTimes Json? // Array of times/positions

  // Restored fields to fix build errors
  place           String?
  course          String?
  actualWeight    String?
  lbw             String?
  runningPosition String?
  horseWeight     String?
  gear            String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([horseId])
}

model Trackwork {
  id          String   @id @default(uuid())
  horseId     String
  horse       Horse    @relation(fields: [horseId], references: [id])
  date        String
  venue       String?   // "ST", "HV"
  type        String?   // "Gallop", "Trotting", "Swimming"
  description String?
  raw         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([horseId, date])
}

model BarrierTrial {
  id          String   @id @default(uuid())
  horseId     String
  horse       Horse    @relation(fields: [horseId], references: [id])
  date        String
  place       String?
  venue       String?
  distance    Int?
  result      String?
  raw         String?
  rank        Int?
  totalHorses Int?
  finishTime  String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([horseId, date])
}

// 評分模型設定 (Scoring Configuration)
model ScoringConfig {
  id          String   @id @default(uuid())
  isActive    Boolean  @default(true)
  name        String   @default("Default Config")
  config      Json     // Stores factors, weights, and rules
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 騎練統計數據 (Jockey/Trainer Stats)
model PersonStats {
  id          String   @id @default(uuid())
  type        String   // "Jockey" or "Trainer"
  hkjcId      String   // e.g. "BH" or "CAS"
  name        String?  // e.g. "Bowman"
  season      String   // "Current" or "Previous"
  stats       Json     // { totalRuns: 100, wins: 10, places: 20, winRate: 10.0, placeRate: 30.0 }
  updatedAt   DateTime @updatedAt

  @@unique([type, hkjcId, season])
}

// 手動調整數據 (Manual Scoring Adjustments)
model RaceScoringAdjustment {
  id          String   @id @default(uuid())
  raceId      String   // HKJC Race ID
  horseNo     Int
  
  // Manual Inputs
  conditionScore  Float?   @default(1.0) // 1-10 or 0-1 range? User said default 1.
  manualPoints    Float?   @default(0.0) // Extra points added/subtracted
  notes           String?
  
  updatedAt       DateTime @updatedAt

  @@unique([raceId, horseNo])
}

// 騎練合作統計 (Jockey-Trainer Partnership)
model JockeyTrainerStats {
  id          String   @id @default(uuid())
  jockeyId    String   // HKJC ID e.g. "BH"
  trainerId   String   // HKJC ID e.g. "CAS"
  season      String   // "Current" or "Previous"
  
  totalRuns   Int      @default(0)
  wins        Int      @default(0)
  places      Int      @default(0) // 1st + 2nd + 3rd
  
  seconds     Int      @default(0)
  thirds      Int      @default(0)
  fourths     Int      @default(0)
  fifths      Int      @default(0)
  
  updatedAt   DateTime @updatedAt

  @@unique([jockeyId, trainerId, season])
}
